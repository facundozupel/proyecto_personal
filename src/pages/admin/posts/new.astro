---
import AdminLayout from '@/layouts/AdminLayout.astro';
import { PostForm } from '@/components/admin/PostForm';
---

<AdminLayout title="Nuevo Post">
  <div class="max-w-4xl mx-auto">
    <div class="mb-8">
      <h2 class="text-3xl font-display font-bold text-neutral-900">Crear Nuevo Post</h2>
      <p class="mt-2 text-neutral-600">
        Completa el formulario para crear un nuevo artículo para el blog
      </p>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-neutral-200 p-8">
      <PostForm client:load />
    </div>
  </div>

  <script>
    import type { PostForm } from '@/components/admin/PostForm';

    // Handle form submission
    window.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('form');
      if (!form) return;

      // Add onSubmit handler via global function
      (window as any).handlePostSubmit = async (data: any) => {
        // Prompt for password
        const password = prompt('Ingresa la contraseña de administrador:');
        if (!password) throw new Error('Contraseña requerida');

        // Parse tags
        const tags = data.tags
          .split(',')
          .map((t: string) => t.trim())
          .filter(Boolean);

        // Send to API
        const response = await fetch('/api/admin/posts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Basic ' + btoa(`admin:${password}`)
          },
          body: JSON.stringify({
            title: data.title,
            description: data.description,
            content: data.content,
            author: data.author,
            readTime: data.readTime,
            tags,
            draft: data.draft
          })
        });

        if (response.status === 401) {
          throw new Error('Contraseña incorrecta');
        }

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al crear el post');
        }

        const result = await response.json();

        alert(`✅ Post creado exitosamente: "${result.post.title}"`);

        // Redirect to admin dashboard
        window.location.href = '/admin';
      };
    });
  </script>

  <!-- Inject submit handler into PostForm -->
  <script is:inline>
    // This will be called by PostForm component
    function getSubmitHandler() {
      return window.handlePostSubmit;
    }
  </script>
</AdminLayout>
