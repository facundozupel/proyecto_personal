---
import AdminLayout from '@/layouts/AdminLayout.astro';
import { getCollection } from 'astro:content';

// Get all blog posts
const allPosts = await getCollection('blog');
const posts = allPosts
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .map((post) => ({
    slug: post.slug,
    title: post.data.title,
    description: post.data.description,
    author: post.data.author,
    date: post.data.date,
    tags: post.data.tags || [],
    draft: post.data.draft || false,
  }));
---

<AdminLayout title="Dashboard">
  <div class="space-y-6">
    {/* Header */}
    <div class="flex justify-between items-center">
      <div>
        <h2 class="text-3xl font-display font-bold text-neutral-900">
          Posts del Blog
        </h2>
        <p class="mt-1 text-neutral-600">
          Gestiona todos tus artículos desde aquí
        </p>
      </div>
      <a
        href="/admin/posts/new"
        class="inline-flex items-center px-6 py-3 bg-primary-600 text-white font-semibold rounded-lg hover:bg-primary-700 transition-colors shadow-md hover:shadow-lg"
      >
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Nuevo Post
      </a>
    </div>

    {/* Stats */}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="bg-white rounded-lg p-6 shadow-sm border border-neutral-200">
        <div class="flex items-center">
          <div class="flex-shrink-0 bg-primary-100 rounded-lg p-3">
            <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-neutral-600">Total Posts</p>
            <p class="text-2xl font-bold text-neutral-900">{posts.length}</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg p-6 shadow-sm border border-neutral-200">
        <div class="flex items-center">
          <div class="flex-shrink-0 bg-success-100 rounded-lg p-3">
            <svg class="w-6 h-6 text-success-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-neutral-600">Publicados</p>
            <p class="text-2xl font-bold text-neutral-900">{posts.filter(p => !p.draft).length}</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg p-6 shadow-sm border border-neutral-200">
        <div class="flex items-center">
          <div class="flex-shrink-0 bg-gold-100 rounded-lg p-3">
            <svg class="w-6 h-6 text-gold-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-neutral-600">Borradores</p>
            <p class="text-2xl font-bold text-neutral-900">{posts.filter(p => p.draft).length}</p>
          </div>
        </div>
      </div>
    </div>

    {/* Posts Table */}
    <div class="bg-white rounded-lg shadow-sm border border-neutral-200 overflow-hidden">
      <table class="min-w-full divide-y divide-neutral-200">
        <thead class="bg-neutral-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">
              Título
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">
              Autor
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">
              Fecha
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">
              Estado
            </th>
            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-neutral-500 uppercase tracking-wider">
              Acciones
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-neutral-200">
          {posts.map((post) => (
            <tr class="hover:bg-neutral-50 transition-colors">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex flex-col">
                  <div class="text-sm font-medium text-neutral-900 line-clamp-1">
                    {post.title}
                  </div>
                  <div class="text-sm text-neutral-500 line-clamp-1">
                    {post.description}
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-neutral-900">{post.author}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-neutral-900">
                  {new Intl.DateTimeFormat('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                  }).format(post.date)}
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                {post.draft ? (
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gold-100 text-gold-800">
                    Borrador
                  </span>
                ) : (
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-success-100 text-success-800">
                    Publicado
                  </span>
                )}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                <a
                  href={`/blog/${post.slug}`}
                  target="_blank"
                  class="text-neutral-600 hover:text-primary-600 transition-colors"
                  title="Ver post"
                >
                  <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                  </svg>
                </a>
                <a
                  href={`/admin/posts/${post.slug}/edit`}
                  class="text-neutral-600 hover:text-primary-600 transition-colors"
                  title="Editar post"
                >
                  <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                </a>
                <button
                  data-delete-slug={post.slug}
                  class="text-neutral-600 hover:text-red-600 transition-colors delete-btn"
                  title="Eliminar post"
                >
                  <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>

      {posts.length === 0 && (
        <div class="text-center py-12">
          <svg class="mx-auto h-12 w-12 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <h3 class="mt-2 text-sm font-medium text-neutral-900">No hay posts</h3>
          <p class="mt-1 text-sm text-neutral-500">Comienza creando tu primer post.</p>
          <div class="mt-6">
            <a
              href="/admin/posts/new"
              class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700"
            >
              <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              Nuevo Post
            </a>
          </div>
        </div>
      )}
    </div>
  </div>

  {/* Delete confirmation script */}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const deleteButtons = document.querySelectorAll('.delete-btn');

      deleteButtons.forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          const slug = (e.currentTarget as HTMLElement).dataset.deleteSlug;

          if (!slug) return;

          if (!confirm(`¿Estás seguro de que quieres eliminar este post?\n\nEsta acción no se puede deshacer.`)) {
            return;
          }

          try {
            // Prompt for password (HTTP Basic Auth)
            const password = prompt('Ingresa la contraseña de administrador:');
            if (!password) return;

            const response = await fetch(`/api/admin/posts/${slug}`, {
              method: 'DELETE',
              headers: {
                'Authorization': 'Basic ' + btoa(`admin:${password}`)
              }
            });

            if (response.ok) {
              alert('Post eliminado correctamente');
              window.location.reload();
            } else if (response.status === 401) {
              alert('Contraseña incorrecta');
            } else {
              const data = await response.json();
              alert(`Error: ${data.error || 'No se pudo eliminar el post'}`);
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Error al eliminar el post');
          }
        });
      });
    });
  </script>
</AdminLayout>
